<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Valentine Game</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <!-- ‚ú® –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô -->
  <link rel="preload" as="image" href="https://img.genially.com/684ea2da1b51060014c50e97/d8e85def-788c-434d-bcf5-d40e6fe8f888.png">
  <link rel="preload" as="image" href="https://img.genially.com/684ea2da1b51060014c50e97/dd62aa0c-fbc5-4ce8-b443-68d1b5fcc4e8.png">
  <link rel="preload" as="image" href="https://img.genially.com/684ea2da1b51060014c50e97/4d1f01fd-30cf-4c17-9456-9177e78273bc.png">
  <link rel="preload" as="image" href="https://img.genially.com/684ea2da1b51060014c50e97/4fd829ec-c34e-42e6-8233-833445b3e56a.png">
  <link rel="preload" as="image" href="https://img.genially.com/684ea2da1b51060014c50e97/2a3daf0b-37d1-4274-a722-548e6200c839.png">
  <link rel="preload" as="image" href="https://img.genially.com/684ea2da1b51060014c50e97/ce1c1977-9c73-42c7-84d8-ebb7e7c4a9b9.png">
  <link rel="preload" as="image" href="https://img.genially.com/684ea2da1b51060014c50e97/fd09a53e-177d-47b1-a552-cacd3874ce31.png">

  <style>
    :root{
      --hero-input-speed: 2.6;

      /* ‚úÖ –§–û–ù –ò–ì–†–´ */
      --bg-image: url("https://img.genially.com/684ea2da1b51060014c50e97/d8e85def-788c-434d-bcf5-d40e6fe8f888.png");
      --bg-overlay: rgba(0, 0, 0, 0.0);

      /* ‚úÖ –ù–ï–ñ–ù–û-–†–û–ó–û–í–ê–Ø –¢–ï–ú–ê */
      --pink-1: #ffd4e5;
      --pink-2: #ffb8d4;
      --pink-3: #ff7fb0;
      --pink-4: #ff4f95;

      --hud-bg: rgba(255, 210, 230, 0.35);
      --hud-border: rgba(255, 255, 255, 0.35);
      --hud-text: #fff7fb;

      --glass-a: rgba(255,255,255,0.30);
      --glass-b: rgba(255,255,255,0.16);
      --glass-stroke: rgba(255,255,255,0.42);
      --glass-shadow: rgba(0,0,0,0.28);

      --accent: var(--pink-3);
      --accent-strong: var(--pink-4);
    }

    html, body{
      width:100%; height:100%;
      overflow:hidden;
      font-family:"Roboto Condensed", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#000;
    }
    body{ margin:0; display:flex; align-items:center; justify-content:center; }
    *{ box-sizing:border-box; margin:0; padding:0; }

    #game{
      position:relative;
      width:100vw; height:100vh;
      background:
        linear-gradient(var(--bg-overlay), var(--bg-overlay)),
        var(--bg-image) center/cover no-repeat;
      overflow:hidden;
      color:#fff;
      font-size:20px;
      outline:none;
      transition: transform 0.1s ease-out;
    }

    /* ‚ú® –ó–í–Å–ó–î–û–ß–ö–ò –ù–ê –§–û–ù–ï */
    .star{
      position: absolute;
      width: 3px;
      height: 3px;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
      opacity: 0;
      animation: twinkle 3s ease-in-out infinite;
      pointer-events: none;
      z-index: 1;
    }
    @keyframes twinkle{
      0%, 100% { opacity: 0; transform: scale(0.5); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    /* =====================
       –ê–ù–ò–ú–ê–¶–ò–ò (FADE + SCALE)
       ===================== */
    @keyframes popIn {
      0%   { opacity: 0; transform: translateY(10px) scale(0.94); filter: blur(2px); }
      70%  { opacity: 1; transform: translateY(0) scale(1.02); filter: blur(0px); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes softGlow {
      0%,100% { box-shadow: 0 22px 60px rgba(255,80,150,0.18); }
      50%     { box-shadow: 0 28px 70px rgba(255,80,150,0.30); }
    }
    @keyframes heartPulse {
      0%, 100% { transform: scale(1); }
      50%      { transform: scale(1.18); }
    }
    
    /* ‚ú® –î–´–•–ê–ù–ò–ï –ö–ù–û–ü–û–ö */
    @keyframes breathe {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.03); }
    }

    /* ===== HUD ===== */
    .hud{
      position:absolute;
      top:12px;
      left:50%;
      transform:translateX(-50%);
      display:flex;
      gap:14px;
      padding:10px 14px;

      background: rgba(90, 0, 45, 0.42);
      border: none;
      border-radius:999px;
      backdrop-filter: blur(10px);
      box-shadow:0 10px 30px rgba(0,0,0,0.25);
      align-items:center;
      z-index:50;
      font-size:18px;
      color: var(--hud-text);
    }
    .hud-item{
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      text-shadow:0 1px 3px rgba(0,0,0,0.55);
    }
    .hud-label{ opacity:.92; }
    .hud-value{
      font-weight:900;
      color:#fff;
      padding: 2px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.25);
      transition: all 0.3s ease;
    }
    
    /* ‚ú® STREAK –°–ß–Å–¢–ß–ò–ö */
    .streak-badge{
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%) scale(0);
      padding: 8px 20px;
      background: linear-gradient(135deg, #ffd700, #ff6b9d);
      border-radius: 999px;
      font-weight: 900;
      font-size: 18px;
      color: #fff;
      box-shadow: 0 8px 25px rgba(255, 107, 157, 0.6);
      z-index: 60;
      opacity: 0;
      animation: streakPop 1.5s ease forwards;
      pointer-events: none;
    }
    @keyframes streakPop{
      0% { opacity: 0; transform: translateX(-50%) scale(0) translateY(20px); }
      20% { opacity: 1; transform: translateX(-50%) scale(1.2) translateY(0); }
      80% { opacity: 1; transform: translateX(-50%) scale(1) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) scale(0.8) translateY(-10px); }
    }

    /* ‚úÖ –ü–†–û–ì–†–ï–°–°-–ë–ê–† */
    .progress-wrap{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .bar{
      width: 240px;
      height: 12px;
      border-radius: 999px;
      background: rgba(90, 0, 45, 0.22);
      overflow:hidden;
      border: none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.10);
    }

    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: rgba(90, 0, 45, 0.32);
      border-radius: 999px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.10);
      transition: width .25s ease;
    }

    /* ===== –ì–ï–†–û–ô ===== */
    #hero{
      position:absolute;
      width:160px;
      height:190px;
      background:url("https://img.genially.com/684ea2da1b51060014c50e97/dd62aa0c-fbc5-4ce8-b443-68d1b5fcc4e8.png") center/contain no-repeat;
      transform-origin:center center;
      transition:transform .12s ease-out;
      z-index:5;
      filter:drop-shadow(0 12px 20px rgba(0,0,0,0.45));
    }

    @keyframes wiggle{
      0%,100%{ transform:translateX(0) scale(var(--hero-scale,1)); }
      25%{ transform:translateX(-8px) rotate(-5deg) scale(var(--hero-scale,1)); }
      50%{ transform:translateX(6px) rotate(4deg) scale(var(--hero-scale,1)); }
      75%{ transform:translateX(-4px) rotate(-3deg) scale(var(--hero-scale,1)); }
    }
    .hero-wiggle{ animation:wiggle .6s ease; }
    
    /* ‚ú® TRAIL –ó–ê –ì–ï–†–û–ï–ú */
    .hero-trail{
      position: absolute;
      width: 120px;
      height: 140px;
      background: radial-gradient(circle, rgba(255, 120, 175, 0.4), transparent 70%);
      border-radius: 50%;
      pointer-events: none;
      z-index: 4;
      opacity: 0;
      animation: trailFade 0.6s ease-out forwards;
    }
    @keyframes trailFade{
      0% { opacity: 0.6; transform: scale(1); }
      100% { opacity: 0; transform: scale(1.5); }
    }

    /* ===== –û–ë–™–ï–ö–¢–´ ===== */
    .item,.candy,.bomb{
      position:absolute;
      cursor:pointer;
      transition:transform .25s ease, opacity .25s ease, filter .2s ease;
      filter:drop-shadow(0 8px 14px rgba(0,0,0,0.4));
      z-index:10;
      background-repeat:no-repeat;
      background-position:center;
    }

    /* ‚úÖ –£–í–ï–õ–ò–ß–ò–õ–ê –í–°–ï –ò–ö–û–ù–ö–ò –ö–†–û–ú–ï –ë–û–ú–ë–´ */
    .item{  width:92px; height:92px; }
    .candy{ width:84px; height:84px; }
    .bomb{  width:130px; height:130px; }
    
    /* ‚ú® –ü–£–õ–¨–°–ê–¶–ò–Ø –°–ï–†–î–ï–¶ */
    .item:not(.collected){
      animation: itemPulse 2s ease-in-out infinite;
    }
    @keyframes itemPulse{
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }

    /* ‚úÖ –°–ï–†–î–¶–ê */
    .item-type-1{
      background-image:url("https://img.genially.com/684ea2da1b51060014c50e97/4d1f01fd-30cf-4c17-9456-9177e78273bc.png");
      background-size:86% 86%;
    }
    .item-type-2{
      background-image:url("https://img.genially.com/684ea2da1b51060014c50e97/4fd829ec-c34e-42e6-8233-833445b3e56a.png");
      background-size:86% 86%;
    }
    .item-type-3{
      background-image:url("https://img.genially.com/684ea2da1b51060014c50e97/2a3daf0b-37d1-4274-a722-548e6200c839.png");
      background-size:86% 86%;
    }

    /* ‚úÖ –ü–ò–°–¨–ú–û-–ë–û–ù–£–° */
    .candy{
      background-image:url("https://img.genially.com/684ea2da1b51060014c50e97/ce1c1977-9c73-42c7-84d8-ebb7e7c4a9b9.png");
      background-size:86% 86%;
    }

    /* ‚úÖ –ì–†–û–ó–û–í–û–ï –û–ë–õ–ê–ö–û */
    .bomb{
      background-image:url("https://img.genially.com/684ea2da1b51060014c50e97/fd09a53e-177d-47b1-a552-cacd3874ce31.png");
      background-size:84% 84%;
    }

    .nearby{
      filter:
        drop-shadow(0 0 5px rgba(255, 200, 225, 0.95))
        drop-shadow(0 0 14px rgba(255, 120, 175, 0.75));
      transform:translateZ(0);
    }

    /* ‚ú® –ü–ê–†–¢–ò–ö–õ–´-–°–ï–†–î–ï–ß–ö–ò */
    .heart-particle{
      position: absolute;
      font-size: 24px;
      pointer-events: none;
      z-index: 45;
      opacity: 0;
      animation: heartParticle 1s ease-out forwards;
    }
    @keyframes heartParticle{
      0% { 
        opacity: 1; 
        transform: translate(0, 0) scale(0.5) rotate(0deg); 
      }
      100% { 
        opacity: 0; 
        transform: translate(var(--tx), var(--ty)) scale(1.2) rotate(360deg); 
      }
    }

    .gold-pop{
      position:absolute;
      width:96px; height:96px;
      pointer-events:none;
      border-radius:50%;
      background: radial-gradient(circle,
        rgba(255,255,255,0.95),
        rgba(255,160,205,0.22) 55%,
        transparent 70%);
      opacity:0;
      transform:scale(.4);
      animation:pop .6s ease-out forwards;
      mix-blend-mode:screen;
      z-index:40;
    }
    @keyframes pop{
      0%{ opacity:0; transform:scale(.2); }
      20%{ opacity:1; transform:scale(1.1); }
      60%{ opacity:.85; transform:scale(.9); }
      100%{ opacity:0; transform:scale(1.35); }
    }

    .floating-score{
      position:absolute;
      color:#fff;
      font-size:24px;
      font-weight:900;
      text-shadow:0 0 10px rgba(0,0,0,0.65);
      pointer-events:none;
      animation:floatScore 1s ease-out forwards;
      z-index:40;
    }
    @keyframes floatScore{
      0%{ opacity:0; transform:translateY(10px) scale(.8); }
      20%{ opacity:1; transform:translateY(0) scale(1); }
      100%{ opacity:0; transform:translateY(-40px) scale(1.05); }
    }

    /* ===== –û–≤–µ—Ä–ª–µ–∏ (—Å—Ç–∞—Ä—Ç –∏ –∫–æ–Ω–µ—Ü) ===== */
    .overlay{
      position:absolute;
      inset:0;
      background: rgba(255, 200, 225, 0.18);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:120;
      backdrop-filter: blur(6px);
    }
    .overlay.active{ display:flex; }

    .overlay-content{
      text-align:center;
      padding:28px 30px 24px;
      border-radius:22px;
      background: rgba(90, 0, 45, 0.42);
      border: none;
      box-shadow: 0 28px 70px rgba(0,0,0,0.35);
      backdrop-filter: blur(12px);
      min-width:min(440px, 92vw);
      max-width:780px;
      font-family:"Roboto Condensed", sans-serif;
      position: relative;
      overflow: hidden;
      animation: popIn .55s ease both, softGlow 2.8s ease-in-out infinite;
    }
    
    .overlay-title, .overlay-sub, .overlay-content button{
      position: relative;
      z-index: 1;
    }

    .overlay-title{
      font-size:28px;
      font-weight:900;
      letter-spacing:0.04em;
      text-transform:uppercase;
      margin-bottom:10px;
      color:#fff;
      text-shadow:
        0 3px 14px rgba(0,0,0,0.45),
        0 0 22px rgba(255,120,170,0.55);
    }
    .overlay-sub{
      font-size:20px;
      line-height:1.3;
      margin-bottom:18px;
      color:#fff0f7;
      white-space:pre-line;
      text-shadow:
        0 3px 12px rgba(0,0,0,0.55),
        0 0 18px rgba(0,0,0,0.25);
    }
    
    /* ‚ú® –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê */
    .stats-grid{
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 20px 0;
      padding: 16px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    .stat-item{
      text-align: center;
      padding: 8px;
    }
    .stat-label{
      font-size: 14px;
      opacity: 0.85;
      margin-bottom: 4px;
    }
    .stat-value{
      font-size: 24px;
      font-weight: 900;
      color: #ffe28a;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
    }

    /* ‚úÖ –ü–£–õ–¨–° –°–ï–†–î–ï–ß–ï–ö –ù–ê –°–¢–ê–†–¢–ï */
    .pulse-heart{
      display:inline-block;
      margin: 0 4px;
      animation: heartPulse 1.2s ease-in-out infinite;
      filter: drop-shadow(0 0 10px rgba(255, 90, 160, 0.55));
    }

    /* ===== –ö–Ω–æ–ø–∫–∏ ===== */
    .btn-primary{
      border:none;
      border-radius:999px;
      padding:10px 26px;
      font-size:20px;
      font-weight:900;
      letter-spacing:.04em;
      text-transform:uppercase;
      cursor:pointer;
      background: linear-gradient(135deg, var(--pink-1), var(--pink-4));
      box-shadow:0 14px 30px rgba(255, 90, 160, 0.35);
      color:#4a0f2a;
      transition:transform .15s ease, box-shadow .15s ease;
      font-family:"Roboto Condensed", sans-serif;
      border:1px solid rgba(255,255,255,0.45);
      
      /* ‚ú® –î–´–•–ê–ù–ò–ï –ö–ù–û–ü–û–ö */
      animation: breathe 2s ease-in-out infinite;
    }
    .btn-primary:hover{
      transform:translateY(-2px);
      box-shadow:0 18px 40px rgba(255, 90, 160, 0.45);
      animation: none;
    }

    /* ===== –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–¥–∞–Ω–∏—è ‚Äî —Ç–æ–∂–µ "–∂–∏–¥–∫–æ–µ —Å—Ç–µ–∫–ª–æ" ===== */
    .modal-backdrop{
      position:absolute;
      inset:0;
      background: radial-gradient(circle at center, rgba(255,180,210,0.22), rgba(0,0,0,0.72));
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100;
      backdrop-filter: blur(6px);
    }
    .modal-backdrop.active{ display:flex; }

    .modal-window{
      position:relative;
      width:min(620px, 92vw);
      padding:26px 34px 22px;
      background: linear-gradient(180deg, rgba(255,255,255,0.40), rgba(255,255,255,0.18));
      border-radius:24px;
      border: 1px solid rgba(255,255,255,0.50);
      box-shadow: 0 28px 60px rgba(0,0,0,0.45);
      backdrop-filter: blur(16px);
      overflow:hidden;
      animation: popIn .45s ease both;
    }
    .modal-window::after{
      content:"";
      position:absolute;
      inset:-40px;
      background:
        radial-gradient(circle at 20% 20%, rgba(255,120,175,0.30), transparent 45%),
        radial-gradient(circle at 80% 10%, rgba(255,220,235,0.25), transparent 45%),
        radial-gradient(circle at 60% 90%, rgba(255,80,150,0.22), transparent 50%);
      z-index:0;
      pointer-events:none;
      filter: blur(10px);
      opacity: 0.9;
    }
    .modal-window > *{ position:relative; z-index:1; }

    .modal-question{
      font-size:22px;
      line-height:1.25;
      margin:0 auto 18px;
      text-align:left;
      max-width:560px;
      color:#2a0b18;
      white-space: pre-wrap;
      font-variant-numeric: tabular-nums;
      text-shadow: 0 2px 10px rgba(255,255,255,0.55);
    }
    .modal-question.mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing: 0;
    }
    .modal-actions{ display:flex; justify-content:center; }

    /* –°–∞–ª—é—Ç-–∫–æ–Ω—Ñ–µ—Ç—Ç–∏ */
    .confetti{
      position:absolute;
      width:12px;
      height:22px;
      border-radius:4px;
      opacity:0;
      pointer-events:none;
      animation:confetti 3s ease-out infinite;
      z-index:115;
      box-shadow:0 0 16px rgba(255, 120, 175, 0.55);
      background: linear-gradient(135deg, var(--pink-2), var(--pink-4));
    }
    .confetti:nth-child(3n){
      background: linear-gradient(135deg, #fff, var(--pink-3));
    }
    .confetti:nth-child(5n){
      background: linear-gradient(135deg, var(--pink-1), #ff5fa7);
    }
    @keyframes confetti{
      0%{ 
        opacity:0; 
        transform:translate3d(0,-100px,0) rotateZ(0deg) scale(0.3); 
      }
      10%{ 
        opacity:1; 
        transform:translate3d(0,-50px,0) rotateZ(60deg) scale(1); 
      }
      30%{ 
        opacity:1; 
        transform:translate3d(0,30vh,0) rotateZ(180deg) scale(1.2); 
      }
      60%{ 
        opacity:1; 
        transform:translate3d(0,70vh,0) rotateZ(300deg) scale(1); 
      }
      100%{ 
        opacity:0; 
        transform:translate3d(0,110vh,0) rotateZ(450deg) scale(0.5); 
      }
    }
  </style>
</head>

<body>
  <div id="game" tabindex="0">
    <div class="hud">
      <div class="hud-item">
        <span class="hud-label">–ë–∞–ª–ª—ã:</span>
        <span id="score" class="hud-value">0</span>
      </div>

      <div class="hud-item progress-wrap">
        <span class="hud-label">–°–æ–±—Ä–∞–Ω–æ:</span>
        <span id="found" class="hud-value">0 / 10</span>
        <span class="bar"><i id="barFill"></i></span>
      </div>
    </div>

    <div id="hero"></div>

    <!-- –°–¢–ê–†–¢ -->
    <div id="startOverlay" class="overlay active">
      <div class="overlay-content">
        <div class="overlay-title">–ü–û–ú–û–ì–ò –°–û–ë–†–ê–¢–¨ –í–ê–õ–ï–ù–¢–ò–ù–ö–ò <span class="pulse-heart">üíó</span></div>
        <div class="overlay-sub">–°–æ–±–∏—Ä–∞–π —Å–µ—Ä–¥—Ü–∞ üíó
–û—Å—Ç–µ—Ä–µ–≥–∞–π—Å—è –≥—Ä–æ–∑–æ–≤–æ–≥–æ –æ–±–ª–∞–∫–∞ ‚õà
–ü–∏—Å—å–º–∞ –±—É–¥—É—Ç –ø—Ä–∏–Ω–æ—Å–∏—Ç—å —Ç–µ–±–µ –±–æ–Ω—É—Å ‚úâÔ∏è</div>
        <button id="btnPlay" class="btn-primary">–ò–≥—Ä–∞—Ç—å</button>
      </div>
    </div>

    <!-- –ö–ê–†–¢–û–ß–ö–ê –ó–ê–î–ê–ù–ò–Ø -->
    <div id="taskModal" class="modal-backdrop">
      <div class="modal-window">
        <div id="modalQuestion" class="modal-question"></div>
        <div class="modal-actions">
          <button id="btnNextTask" class="btn-primary">–î–∞–ª–µ–µ</button>
        </div>
      </div>
    </div>

    <!-- –§–ò–ù–ê–õ -->
    <div id="gameOverOverlay" class="overlay">
      <div class="overlay-content">
        <div class="overlay-title" id="overlayTitle">–£–†–ê! <span class="pulse-heart">üíñ</span></div>
        <div class="overlay-sub" id="overlaySub">–ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –¢—ã —Å–æ–±—Ä–∞–ª(–∞) –≤—Å–µ –≤–∞–ª–µ–Ω—Ç–∏–Ω–∫–∏! ‚ú®</div>
        <div id="statsContainer"></div>
        <button id="btnRestart" class="btn-primary">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ?</button>
      </div>
    </div>
  </div>

  <script>
    const gameEl = document.getElementById('game');
    const heroEl = document.getElementById('hero');
    const scoreEl = document.getElementById('score');
    const foundEl = document.getElementById('found');
    const barFill = document.getElementById('barFill');

    const startOverlay = document.getElementById('startOverlay');
    const btnPlay = document.getElementById('btnPlay');

    const taskModal = document.getElementById('taskModal');
    const modalQuestionEl = document.getElementById('modalQuestion');
    const btnNextTask = document.getElementById('btnNextTask');

    const gameOverOverlay = document.getElementById('gameOverOverlay');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlaySub = document.getElementById('overlaySub');
    const statsContainer = document.getElementById('statsContainer');
    const btnRestart = document.getElementById('btnRestart');

    const HERO_BASE_SIZE = { w: 160, h: 190 };
    let HERO_INPUT_SPEED = 2.6;

    const HERO_GROWTH_PER_COLLECT = 0.05;
    const NUM_MAIN_ITEMS = 11;
    const NUM_CANDIES = 3;
    const NUM_BOMBS = 2;

    const SPAWN_BATCH_MIN = 2;
    const SPAWN_BATCH_MAX = 3;
    const SPAWN_INTERVAL = 1200;

    const NEARBY_DISTANCE = 125;

    let hero = { x: 200, y: 200, scale: 1, flipped: false };
    let keys = { ArrowUp:false, ArrowDown:false, ArrowLeft:false, ArrowRight:false };

    let items = [];
    let candies = [];
    let bombs = [];

    let pendingMain = NUM_MAIN_ITEMS;
    let pendingCandies = NUM_CANDIES;
    let pendingBombs = NUM_BOMBS;
    let spawnTimer = null;

    let score = 0;
    let foundCount = 0;
    let isWin = false;
    let modalOpen = false;
    
    // ‚ú® –ù–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø WOW-–≠–§–§–ï–ö–¢–û–í
    let streak = 0;
    let lastCollectTime = 0;
    const STREAK_TIMEOUT = 3000;
    let gameStartTime = 0;
    let totalClicks = 0;
    let trailTimer = null;

    const TASK_CARDS = [
`–†–µ—à–∏ –∑–∞–¥–∞—á—É:

–ö –ø—Ä–∞–∑–¥–Ω–∏–∫—É –∫—É–ø–∏–ª–∏ 24 –∫–≥ –≥—Ä—É—à, –∞ —è–±–ª–æ–∫ ‚Äì –Ω–∞ 4 –∫–≥ –±–æ–ª—å—à–µ.
–°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –∫–∏–ª–æ–≥—Ä–∞–º–º–æ–≤ —Ñ—Ä—É–∫—Ç–æ–≤ –∫—É–ø–∏–ª–∏ –∫ –ø—Ä–∞–∑–¥–Ω–∏–∫—É?`,

`–í—ã—á–∏—Å–ª–∏ —Å—Ç–æ–ª–±–∏–∫–æ–º:

53 + 37 =        86 ‚Äì 38 =
36 + 48 =        80 ‚Äì 56 =
65 + 17 =        81 ‚Äì 39 =`,

`–†–µ—à–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏—è:

74 ‚Äì —Ö = 41

30 + —Ö = 67`,

`–†–µ—à–∏ –∑–∞–¥–∞—á—É:

–ù–∞—á–µ—Ä—Ç–∏ –∫–≤–∞–¥—Ä–∞—Ç —Å–æ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏ 3 —Å–º.
–ù–∞–π–¥–∏ –ø–µ—Ä–∏–º–µ—Ç—Ä –∫–≤–∞–¥—Ä–∞—Ç–∞.`,

`–°—Ä–∞–≤–Ω–∏, –≤—Å—Ç–∞–≤—å –∑–Ω–∞–∫–∏ ¬´<¬ª, ¬´>¬ª –∏–ª–∏ ¬´=¬ª:

3 –¥–º 2 —Å–º __ 23 —Å–º        1 —Å–º __ 30 –º–º
8 + 5 __ 14                1 —á __ 30 –º–∏–Ω`,

`–í—Å—Ç–∞–≤—å —á–∏—Å–ª–∞ —Ç–∞–∫, —á—Ç–æ–±—ã –∑–∞–ø–∏—Å–∏ –±—ã–ª–∏ –≤–µ—Ä–Ω—ã–º–∏:

5 –º 8 –¥–º = ___ –¥–º        60 –º–º = ___ —Å–º
6 –¥–º 3 —Å–º = ___ —Å–º       50 –º–º = ___ —Å–º`,

`–†–µ—à–∏ –∑–∞–¥–∞—á—É:

–®–∫–æ–ª—å–Ω–∏–∫–∏ –ø–æ—Å–∞–¥–∏–ª–∏ 14 —Ç—é–ª—å–ø–∞–Ω–æ–≤, –∞ —Ä–æ–º–∞—à–µ–∫ –Ω–∞ 6 –º–µ–Ω—å—à–µ.
–°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ —Ü–≤–µ—Ç–æ–≤ –ø–æ—Å–∞–¥–∏–ª–∏ —à–∫–æ–ª—å–Ω–∏–∫–∏?`,

`–í—ã—á–∏—Å–ª–∏ —Å—Ç–æ–ª–±–∏–∫–æ–º:

26 + 47 =        81 ‚Äì 25 =
44 + 36 =        70 ‚Äì 27 =
69 + 17 =        41 ‚Äì 29 =`,

`–†–µ—à–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏—è:

—Ö + 40 = 59

—Ö ‚Äì 17 = 33`,

`–†–µ—à–∏ –∑–∞–¥–∞—á—É:

–ù–∞—á–µ—Ä—Ç–∏ –∫–≤–∞–¥—Ä–∞—Ç —Å–æ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏ 6 —Å–º.
–ù–∞–π–¥–∏ –ø–µ—Ä–∏–º–µ—Ç—Ä –∫–≤–∞–¥—Ä–∞—Ç–∞.`,

`–°—Ä–∞–≤–Ω–∏, –≤—Å—Ç–∞–≤—å –∑–Ω–∞–∫–∏ ¬´<¬ª, ¬´>¬ª –∏–ª–∏ ¬´=¬ª:

4 —Å–º 2 –º–º __ 24 –º–º        1 –º __ 100 —Å–º
7 + 4 __ 19                59 –º–∏–Ω __ 1 —á`
    ];

    /* ===== –ó–í–£–ö–ò (WebAudio) ===== */
    let audioCtx = null;
    function ensureAudio(){
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume();
    }
    function beep({freq=440, dur=0.08, type='sine', vol=0.12, slideTo=null}={}){
      if (!audioCtx) return;
      const t0 = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, t0);
      if (slideTo) osc.frequency.exponentialRampToValueAtTime(slideTo, t0 + dur);

      gain.gain.setValueAtTime(0.0001, t0);
      gain.gain.exponentialRampToValueAtTime(vol, t0 + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

      osc.connect(gain).connect(audioCtx.destination);
      osc.start(t0);
      osc.stop(t0 + dur + 0.02);
    }
    const SFX = {
      start(){ beep({freq:523, dur:0.07, type:'triangle', vol:0.10}); setTimeout(()=>beep({freq:659,dur:0.07,type:'triangle',vol:0.10}),80); },
      card(){ beep({freq:440, dur:0.06, type:'triangle', vol:0.10}); },
      collect(){ beep({freq:740, dur:0.07, type:'triangle', vol:0.12}); setTimeout(()=>beep({freq:880,dur:0.08,type:'triangle',vol:0.12}),70); },
      bonus(){ beep({freq:740, dur:0.06, type:'sine', vol:0.12}); setTimeout(()=>beep({freq:988,dur:0.06,type:'sine',vol:0.12}),60); setTimeout(()=>beep({freq:1175,dur:0.08,type:'sine',vol:0.12}),120); },
      bomb(){ beep({freq:160, dur:0.16, type:'sawtooth', vol:0.16, slideTo:60}); },
      win(){ beep({freq:523, dur:0.08, type:'triangle', vol:0.12}); setTimeout(()=>beep({freq:659,dur:0.08,type:'triangle',vol:0.12}),90); setTimeout(()=>beep({freq:784,dur:0.10,type:'triangle',vol:0.12}),180); },
      streak(){ beep({freq:880, dur:0.06, type:'sine', vol:0.14}); setTimeout(()=>beep({freq:1047,dur:0.06,type:'sine',vol:0.14}),50); }
    };

    let freezeUntil = 0;
    let lastMove = { x: 0, y: 1 };
    function freeze(ms=240){
      freezeUntil = Date.now() + ms;
      keys.ArrowUp = keys.ArrowDown = keys.ArrowLeft = keys.ArrowRight = false;
    }
    function knockback(px=10){
      const w = gameEl.clientWidth;
      const h = gameEl.clientHeight;
      const heroW = HERO_BASE_SIZE.w * hero.scale;
      const heroH = HERO_BASE_SIZE.h * hero.scale;
      const margin = 5;

      hero.x -= lastMove.x * px;
      hero.y -= lastMove.y * px;

      if (hero.x <= margin) hero.x = margin;
      else if (hero.x + heroW >= w - margin) hero.x = w - margin - heroW;

      if (hero.y <= 60) hero.y = 60;
      else if (hero.y + heroH >= h - margin) hero.y = h - margin - heroH;
    }
    
    // ‚ú® CAMERA SHAKE
    function cameraShake(intensity = 10, duration = 300){
      const startTime = Date.now();
      const shake = () => {
        const elapsed = Date.now() - startTime;
        if(elapsed < duration){
          const x = (Math.random() - 0.5) * intensity;
          const y = (Math.random() - 0.5) * intensity;
          gameEl.style.transform = `translate(${x}px, ${y}px)`;
          requestAnimationFrame(shake);
        } else {
          gameEl.style.transform = 'translate(0, 0)';
        }
      };
      shake();
    }
    
    // ‚ú® –°–û–ó–î–ê–ù–ò–ï –ó–í–Å–ó–î–û–ß–ï–ö –ù–ê –§–û–ù–ï
    function createStars(){
      const count = 50;
      for(let i = 0; i < count; i++){
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 3 + 's';
        star.style.animationDuration = (2 + Math.random() * 2) + 's';
        gameEl.appendChild(star);
      }
    }
    
    // ‚ú® TRAIL –ó–ê –ì–ï–†–û–ï–ú
    function createTrail(){
      if(trailTimer) return;
      trailTimer = setInterval(() => {
        if(modalOpen || isWin) return;
        
        let dx = 0, dy = 0;
        if(keys.ArrowUp) dy -= 1;
        if(keys.ArrowDown) dy += 1;
        if(keys.ArrowLeft) dx -= 1;
        if(keys.ArrowRight) dx += 1;
        
        if(dx !== 0 || dy !== 0){
          const trail = document.createElement('div');
          trail.className = 'hero-trail';
          trail.style.left = (hero.x + 20) + 'px';
          trail.style.top = (hero.y + 25) + 'px';
          gameEl.appendChild(trail);
          setTimeout(() => trail.remove(), 600);
        }
      }, 80);
    }
    
    // ‚ú® –ü–ê–†–¢–ò–ö–õ–´-–°–ï–†–î–ï–ß–ö–ò
    function createHeartParticles(x, y){
      const hearts = ['üíó', 'üíñ', 'üíï', 'üíù'];
      const count = 8;
      
      for(let i = 0; i < count; i++){
        const particle = document.createElement('div');
        particle.className = 'heart-particle';
        particle.textContent = hearts[Math.floor(Math.random() * hearts.length)];
        
        const angle = (Math.PI * 2 * i) / count;
        const distance = 60 + Math.random() * 40;
        const tx = Math.cos(angle) * distance;
        const ty = Math.sin(angle) * distance;
        
        particle.style.left = x + 'px';
        particle.style.top = y + 'px';
        particle.style.setProperty('--tx', tx + 'px');
        particle.style.setProperty('--ty', ty + 'px');
        particle.style.animationDelay = (i * 0.05) + 's';
        
        gameEl.appendChild(particle);
        setTimeout(() => particle.remove(), 1000);
      }
    }
    
    // ‚ú® –ü–û–ö–ê–ó STREAK
    function showStreak(){
      const existing = document.querySelector('.streak-badge');
      if(existing) existing.remove();
      
      const badge = document.createElement('div');
      badge.className = 'streak-badge';
      
      let bonusPoints = 0;
      if(streak >= 3) bonusPoints = 2;
      if(streak >= 5) bonusPoints = 5;
      if(streak >= 7) bonusPoints = 10;
      
      badge.textContent = `üî• –ü–æ–¥—Ä—è–¥ x${streak}! +${bonusPoints} –±–∞–ª–ª–æ–≤`;
      gameEl.appendChild(badge);
      
      score += bonusPoints;
      updateHUD();
      SFX.streak();
      
      setTimeout(() => badge.remove(), 1500);
    }

    function rand(min, max){ return Math.random() * (max - min) + min; }
    function distance(ax, ay, bx, by){
      const dx = ax - bx, dy = ay - by;
      return Math.sqrt(dx*dx + dy*dy);
    }
    function rectsOverlap(ax, ay, aw, ah, bx, by, bw, bh){
      return !(ax + aw < bx || ax > bx + bw || ay + ah < by || ay > by + bh);
    }
    function anyOverlap(x, y, size){
      const all = [
        ...items.map(i => ({ x: i.x, y: i.y, w: i.size, h: i.size })),
        ...candies.map(c => ({ x: c.x, y: c.y, w: c.size, h: c.size })),
        ...bombs.map(b => ({ x: b.x, y: b.y, w: b.size, h: b.size }))
      ];
      for (const o of all){
        if (rectsOverlap(x, y, size, size, o.x, o.y, o.w, o.h)) return true;
      }
      return false;
    }
    function findNonOverlappingPosition(size){
      const w = gameEl.clientWidth;
      const h = gameEl.clientHeight;
      const MAX_TRIES = 250;
      for (let i=0;i<MAX_TRIES;i++){
        const x = rand(40, w - size - 40);
        const y = rand(80, h - size - 80);
        if (!anyOverlap(x, y, size)){
          const heroCx = hero.x + HERO_BASE_SIZE.w / 2;
          const heroCy = hero.y + HERO_BASE_SIZE.h / 2;
          const objCx = x + size / 2;
          const objCy = y + size / 2;
          if (distance(heroCx, heroCy, objCx, objCy) > NEARBY_DISTANCE + 30) return {x,y};
        }
      }
      return { x: rand(40, w - size - 40), y: rand(80, h - size - 80) };
    }

    function clearObjects(){
      [...document.querySelectorAll('.item, .candy, .bomb, .gold-pop, .floating-score, .confetti, .heart-particle')]
        .forEach(el => el.remove());
      items = []; candies = []; bombs = [];
    }

    function updateHUD(){
      scoreEl.textContent = score;
      foundEl.textContent = foundCount + " / " + NUM_MAIN_ITEMS;
      const pct = Math.max(0, Math.min(100, (foundCount / NUM_MAIN_ITEMS) * 100));
      barFill.style.width = pct + "%";
      
      // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
      scoreEl.style.transform = 'scale(1.2)';
      setTimeout(() => scoreEl.style.transform = 'scale(1)', 200);
    }

    function updateHeroVisual(){
      heroEl.style.left = hero.x + "px";
      heroEl.style.top = hero.y + "px";
      heroEl.style.setProperty("--hero-scale", hero.scale);
      const scaleX = hero.flipped ? -hero.scale : hero.scale;
      heroEl.style.transform = `scale(${scaleX}, ${hero.scale})`;
    }

    function spawnBatch(){
      if (pendingMain<=0 && pendingCandies<=0 && pendingBombs<=0){
        clearInterval(spawnTimer);
        spawnTimer = null;
        return;
      }
      let toSpawn = Math.floor(rand(SPAWN_BATCH_MIN, SPAWN_BATCH_MAX + 1));
      while (toSpawn>0 && (pendingMain>0 || pendingCandies>0 || pendingBombs>0)){
        const choices = [];
        if (pendingMain>0) choices.push("main");
        if (pendingCandies>0) choices.push("candy");
        if (pendingBombs>0) choices.push("bomb");

        const type = choices[Math.floor(Math.random()*choices.length)];
        if (type==="main" && pendingMain>0){ spawnMainItem(NUM_MAIN_ITEMS - pendingMain); pendingMain--; }
        else if (type==="candy" && pendingCandies>0){ spawnCandy(NUM_CANDIES - pendingCandies); pendingCandies--; }
        else if (type==="bomb" && pendingBombs>0){ spawnBomb(NUM_BOMBS - pendingBombs); pendingBombs--; }
        toSpawn--;
      }
    }

    function spawnMainItem(index){
      const id = "item-" + index;
      const type = (index % 3) + 1;
      const size = 92;
      const pos = findNonOverlappingPosition(size);

      const el = document.createElement("div");
      el.classList.add("item", `item-type-${type}`);
      el.style.left = pos.x + "px";
      el.style.top = pos.y + "px";

      el.addEventListener("click", () => {
        if (isWin || modalOpen) return;
        const obj = items.find(it => it.id === id);
        if (!obj || obj.collected) return;
        if (!obj.active) return;
        totalClicks++;
        openTaskCard(obj.orderIndex);
      });

      gameEl.appendChild(el);
      items.push({ id, x: pos.x, y: pos.y, size, el, collected:false, active:false, orderIndex:index });
    }

    function spawnCandy(index){
      const id = "candy-" + index;
      const size = 84;
      const pos = findNonOverlappingPosition(size);

      const el = document.createElement("div");
      el.classList.add("candy");
      el.style.left = pos.x + "px";
      el.style.top = pos.y + "px";

      gameEl.appendChild(el);
      candies.push({ id, x: pos.x, y: pos.y, size, el, eaten:false });
    }

    function spawnBomb(index){
      const id = "bomb-" + index;
      const size = 130;
      const pos = findNonOverlappingPosition(size);

      const el = document.createElement("div");
      el.classList.add("bomb");
      el.style.left = pos.x + "px";
      el.style.top = pos.y + "px";

      gameEl.appendChild(el);
      bombs.push({ id, x: pos.x, y: pos.y, size, el, exploded:false });
    }

    function updateNearby(){
      const heroCenterX = hero.x + HERO_BASE_SIZE.w * hero.scale / 2;
      const heroCenterY = hero.y + HERO_BASE_SIZE.h * hero.scale / 2;

      items.forEach(it => {
        if (it.collected){ it.active=false; it.el.classList.remove("nearby"); return; }
        const cx = it.x + it.size/2, cy = it.y + it.size/2;
        const isNear = distance(heroCenterX, heroCenterY, cx, cy) <= NEARBY_DISTANCE;
        it.active = isNear;
        it.el.classList.toggle("nearby", isNear);
      });

      candies.forEach(c => {
        const cx = c.x + c.size/2, cy = c.y + c.size/2;
        const isNear = distance(heroCenterX, heroCenterY, cx, cy) <= NEARBY_DISTANCE;
        c.el.classList.toggle("nearby", isNear && !c.eaten);
      });

      bombs.forEach(b => {
        const cx = b.x + b.size/2, cy = b.y + b.size/2;
        const isNear = distance(heroCenterX, heroCenterY, cx, cy) <= NEARBY_DISTANCE;
        b.el.classList.toggle("nearby", isNear && !b.exploded);
      });
    }

    function moveHeroByInput(){
      if (modalOpen) return;
      if (Date.now() < freezeUntil) return;

      let dx=0, dy=0;
      if (keys.ArrowUp) dy -= 1;
      if (keys.ArrowDown) dy += 1;
      if (keys.ArrowLeft) dx -= 1;
      if (keys.ArrowRight) dx += 1;
      if (dx===0 && dy===0) return;

      const len = Math.hypot(dx, dy) || 1;
      const ndx = dx/len, ndy = dy/len;
      lastMove.x = ndx; lastMove.y = ndy;

      const stepX = ndx * HERO_INPUT_SPEED;
      const stepY = ndy * HERO_INPUT_SPEED;

      if (stepX < 0) hero.flipped = true;
      if (stepX > 0) hero.flipped = false;

      const w = gameEl.clientWidth, h = gameEl.clientHeight;
      const heroW = HERO_BASE_SIZE.w * hero.scale;
      const heroH = HERO_BASE_SIZE.h * hero.scale;
      const margin = 5;

      hero.x += stepX; hero.y += stepY;

      if (hero.x <= margin) hero.x = margin;
      else if (hero.x + heroW >= w - margin) hero.x = w - margin - heroW;

      if (hero.y <= 60) hero.y = 60;
      else if (hero.y + heroH >= h - margin) hero.y = h - margin - heroH;
    }

    function showGoldPop(cx, cy){
      const pop = document.createElement("div");
      pop.className = "gold-pop";
      pop.style.left = (cx - 48) + "px";
      pop.style.top = (cy - 48) + "px";
      gameEl.appendChild(pop);
      setTimeout(()=>pop.remove(), 650);
    }
    function showFloatingScore(text, x, y){
      const fs = document.createElement("div");
      fs.className = "floating-score";
      fs.textContent = text;
      fs.style.left = x + "px";
      fs.style.top = y + "px";
      gameEl.appendChild(fs);
      setTimeout(()=>fs.remove(), 1100);
    }

    function checkCollisions(){
      const heroW = HERO_BASE_SIZE.w * hero.scale;
      const heroH = HERO_BASE_SIZE.h * hero.scale;

      candies.forEach(c => {
        if (c.eaten) return;
        if (rectsOverlap(hero.x, hero.y, heroW, heroH, c.x, c.y, c.size, c.size)){
          freeze(260); knockback(10); SFX.bonus();
          c.eaten = true;
          c.el.style.opacity = "0";
          c.el.style.transform = "scale(0.3)";
          setTimeout(()=>c.el.remove(), 250);
          score += 5;
          showGoldPop(c.x + c.size/2, c.y + c.size/2);
          showFloatingScore("+5", c.x + c.size/2, c.y);
          updateHUD();
        }
      });

      bombs.forEach(b => {
        if (b.exploded) return;
        if (rectsOverlap(hero.x, hero.y, heroW, heroH, b.x, b.y, b.size, b.size)){
          freeze(340); knockback(14); SFX.bomb();
          cameraShake(12, 400); // ‚ú® CAMERA SHAKE
          b.exploded = true;
          b.el.style.opacity = "0";
          b.el.style.transform = "scale(0.35)";
          setTimeout(()=>b.el.remove(), 250);
          heroEl.classList.remove("hero-wiggle");
          void heroEl.offsetWidth;
          heroEl.classList.add("hero-wiggle");
          
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º streak –ø—Ä–∏ –ø–æ–ø–∞–¥–∞–Ω–∏–∏ –≤ –æ–±–ª–∞–∫–æ
          streak = 0;
        }
      });
    }

    let pendingCollectIndex = null;

    function openTaskCard(taskIndex){
      freeze(260); knockback(10);
      SFX.card();

      pendingCollectIndex = taskIndex;

      const txt = TASK_CARDS.length
        ? TASK_CARDS[taskIndex % TASK_CARDS.length]
        : "–î–æ–±–∞–≤—å –∑–∞–¥–∞–Ω–∏—è –≤ –º–∞—Å—Å–∏–≤ TASK_CARDS";

      modalQuestionEl.classList.toggle('mono', [1, 2, 4, 5, 7, 8, 10].includes(taskIndex));
      modalQuestionEl.textContent = txt;

      modalOpen = true;
      taskModal.classList.add("active");
    }

    function closeTaskCardAndCollect(){
      taskModal.classList.remove("active");
      modalOpen = false;

      if (pendingCollectIndex === null) return;
      const id = "item-" + pendingCollectIndex;
      const item = items.find(it => it.id === id);
      if (!item || item.collected){ pendingCollectIndex = null; return; }

      item.collected = true;
      item.el.classList.add('collected');
      item.el.style.transform = "scale(0.1)";
      item.el.style.opacity = "0";

      const cx = item.x + item.size/2;
      const cy = item.y + item.size/2;

      SFX.collect();
      showGoldPop(cx, cy);
      createHeartParticles(cx, cy); // ‚ú® –ü–ê–†–¢–ò–ö–õ–´-–°–ï–†–î–ï–ß–ö–ò
      showFloatingScore("+10", cx, cy - 10);
      setTimeout(()=>item.el.remove(), 250);

      hero.scale += HERO_GROWTH_PER_COLLECT;
      updateHeroVisual();

      score += 10;
      foundCount++;
      
      // ‚ú® STREAK –°–ò–°–¢–ï–ú–ê
      const now = Date.now();
      if(now - lastCollectTime < STREAK_TIMEOUT){
        streak++;
        if(streak >= 3){
          showStreak();
        }
      } else {
        streak = 1;
      }
      lastCollectTime = now;
      
      updateHUD();

      pendingCollectIndex = null;

      if (foundCount >= NUM_MAIN_ITEMS){
        isWin = true;
        
        // ‚ú® –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
        const gameTime = Math.floor((Date.now() - gameStartTime) / 1000);
        const minutes = Math.floor(gameTime / 60);
        const seconds = gameTime % 60;
        const accuracy = Math.round((foundCount / totalClicks) * 100);
        
        overlayTitle.innerHTML = '–£–†–ê! <span class="pulse-heart">üíñ</span>';
        overlaySub.textContent = "–ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –¢—ã —Å–æ–±—Ä–∞–ª(–∞) –≤—Å–µ –≤–∞–ª–µ–Ω—Ç–∏–Ω–∫–∏!\n–¢—ã –º–æ–ª–æ–¥–µ—Ü ‚ú®";
        
        statsContainer.innerHTML = `
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-label">‚è±Ô∏è –í—Ä–µ–º—è</div>
              <div class="stat-value">${minutes}:${seconds.toString().padStart(2, '0')}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">üéØ –¢–æ—á–Ω–æ—Å—Ç—å</div>
              <div class="stat-value">${accuracy}%</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">‚≠ê –ë–∞–ª–ª—ã</div>
              <div class="stat-value">${score}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">üíù –°–æ–±—Ä–∞–Ω–æ</div>
              <div class="stat-value">${foundCount}/${NUM_MAIN_ITEMS}</div>
            </div>
          </div>
        `;
        
        gameOverOverlay.classList.add("active");
        addConfetti();
        SFX.win();
      }
    }

    function addConfetti(){
      const count = 170;
      for (let i=0;i<count;i++){
        const c = document.createElement("div");
        c.className = "confetti";
        c.style.left = rand(0,100) + "%";
        c.style.top = rand(-20,60) + "%";
        c.style.animationDelay = (Math.random()*2) + "s";
        c.style.animationDuration = (2.5 + Math.random()*1.5) + "s";
        gameEl.appendChild(c);
      }
    }

    function initGame(){
      const cs = getComputedStyle(document.documentElement);
      HERO_INPUT_SPEED = parseFloat(cs.getPropertyValue("--hero-input-speed")) || 2.6;

      score = 0;
      foundCount = 0;
      isWin = false;
      modalOpen = false;
      pendingCollectIndex = null;
      freezeUntil = 0;
      
      // ‚ú® –°–ë–†–û–° –ù–û–í–´–• –ü–ï–†–ï–ú–ï–ù–ù–´–•
      streak = 0;
      lastCollectTime = 0;
      gameStartTime = Date.now();
      totalClicks = 0;

      hero.scale = 1;
      hero.x = gameEl.clientWidth/2 - HERO_BASE_SIZE.w/2;
      hero.y = gameEl.clientHeight/2 - HERO_BASE_SIZE.h/2;
      hero.flipped = false;
      updateHeroVisual();

      document.querySelectorAll(".confetti, .star, .streak-badge").forEach(el => el.remove());
      gameOverOverlay.classList.remove("active");

      clearObjects();
      pendingMain = NUM_MAIN_ITEMS;
      pendingCandies = NUM_CANDIES;
      pendingBombs = NUM_BOMBS;

      updateHUD();
      
      // ‚ú® –°–û–ó–î–ê–ù–ò–ï –ó–í–Å–ó–î–û–ß–ï–ö
      createStars();
      
      // ‚ú® –ó–ê–ü–£–°–ö TRAIL
      createTrail();

      if (spawnTimer) clearInterval(spawnTimer);
      spawnTimer = setInterval(spawnBatch, SPAWN_INTERVAL);

      requestAnimationFrame(gameLoop);
    }

    function gameLoop(){
      if (isWin) return;
      moveHeroByInput();
      updateHeroVisual();
      updateNearby();
      checkCollisions();
      requestAnimationFrame(gameLoop);
    }

    window.addEventListener("keydown", e => {
      if (e.key in keys){
        keys[e.key] = true;
        e.preventDefault();
      }
    }, { passive:false });

    window.addEventListener("keyup", e => {
      if (e.key in keys){
        keys[e.key] = false;
        e.preventDefault();
      }
    }, { passive:false });

    gameEl.addEventListener("pointerdown", () => { gameEl.focus(); ensureAudio(); });

    btnPlay.addEventListener("click", () => {
      ensureAudio(); SFX.start();
      startOverlay.classList.remove("active");
      initGame();
      gameEl.focus();
    });

    btnNextTask.addEventListener("click", () => {
      ensureAudio();
      closeTaskCardAndCollect();
      gameEl.focus();
    });

    btnRestart.addEventListener("click", () => {
      ensureAudio();
      initGame();
      gameEl.focus();
    });

    window.addEventListener("resize", () => {
      if (!startOverlay.classList.contains("active")) initGame();
    });
  </script>
</body>
</html>
